<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chapter – ChapterFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../Style.css">

  <!-- Appwrite SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>

  <!-- MAIN SCRIPT (bubble timer, auth, etc.) -->
  <!-- added so the reading bubble can run on this page -->
  <script src="../script.js" defer></script>

  <style>
    body.chapter-page {
      margin: 0;
      font-family: "Merriweather", serif;
      background-color: #f7f3e9;
      color: #3c2b1a;
      position: relative;
    }

    .chapter-banner {
      background-color: var(--footer-bg);
      height: 250px;
      width: 100%;
    }

    .chapter-layout {
      max-width: 880px;
      margin: 0 auto -100px;
      padding: 0 16px 48px;
      position: relative;
      top: -140px;
    }

    .chapter-back-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid black;
      background-color: #f2eee5;
      color: #3c2b1a;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      z-index: 10;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }

    .chapter-back-btn:hover {
      background-color: #e8dbc9;
    }

    .chapter-card {
      background-color: #fff;
      border-radius: 0px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      padding: 24px 28px 32px;
      position: relative;
      overflow: hidden;
      min-height: 800px;
    }

    .chapter-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle at top left, rgba(201,177,132,0.18) 0, transparent 60%);
      pointer-events: none;
    }

    .chapter-card-inner {
      position: relative;
      z-index: 1;
    }

    .chapter-series-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #a0885c;
      margin-bottom: 4px;
    }

    .chapter-series-name {
      font-size: 0.95rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #7a6238;
      margin-bottom: 16px;
    }

    .chapter-title {
      font-size: 1.6rem;
      margin: 0 0 4px;
      color: #2b1c0b;
    }

    .chapter-author {
      font-size: 0.9rem;
      margin: 0 0 16px;
      color: #6c5a3c;
    }

    .chapter-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: #8b7a5b;
      border-bottom: 1px solid #e4d7c1;
      padding-bottom: 8px;
      margin-bottom: 18px;
    }

    .chapter-body {
      margin-top: 4px;
      font-size: 1rem;
      line-height: 1.8;
      color: rgba(0, 0, 0, 0.85);
      white-space: normal;
      position: relative;
    }

    .chapter-body p {
      margin: 0 0 1em;
    }

    .chapter-body .editor-image {
      position: absolute;
      left: 50% !important;
      transform: translateX(-50%);
    }

    .chapter-body .editor-image img {
      display: block;
      max-width: 100%;
      height: auto !important;
    }

    .chapter-body .editor-image-resize {
      display: none;
    }

    .chapter-empty-message {
      font-size: 0.95rem;
      color: #9b8b6b;
      font-style: italic;
      margin-top: 16px;
    }

    /* Navigation buttons for previous/next chapters */
    .chapter-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 24px 0;
      width: 100%;
    }
    .chapter-navigation button {
      background: none;
      border: none;
      padding: 8px 16px;
      font-size: 1rem;
      color: #7a6238;
      cursor: pointer;
      transition: color 0.25s ease;   /* smooth color change */
    }

    .chapter-navigation button:hover:not(:disabled) {
      color: orangered;               /* hover color */
    }

    .chapter-navigation button:disabled {
      color: #ccc;
      cursor: default;
      text-decoration: none;
    }

    .chapter-not-found {
      max-width: 880px;
      margin: 0 auto;
      padding: 16px;
      font-size: 0.95rem;
      color: #7a4b3a;
      background-color: #fbe9e6;
      border-radius: 12px;
      border: 1px solid #f2c2b8;
    }

    @media (max-width: 600px) {
      .chapter-layout {
        padding: 0 10px 40px;
      }

      .chapter-card {
        padding: 18px 18px 28px;
      }

      .chapter-title {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body class="chapter-page">
  <div class="chapter-banner"></div>

  <!-- added reader-page class so script.js recognizes this as a reading page -->
  <main class="chapter-layout reader-page">
    <button id="chapter-back-btn" class="chapter-back-btn">
      ← Back
    </button>

    <section class="chapter-card">
      <div class="chapter-card-inner">
        <div class="chapter-series-label">Series</div>
        <div id="chapter-series-name" class="chapter-series-name"></div>

        <p id="chapter-author" class="chapter-author"></p>

        <div class="chapter-meta-row">
          <span id="chapter-meta-left"></span>
          <span id="chapter-meta-right"></span>
        </div>

        <article id="chapter-body" class="chapter-body">
          <!-- Full chapter content (HTML) goes here -->
        </article>

        <p id="chapter-empty" class="chapter-empty-message" style="display:none;">
          This chapter doesn’t have any content yet. Once you wire the upload page to save chapters,
          the full text will be shown here.
        </p>
      </div>
    </section>

    <!-- Navigation buttons for previous and next chapters -->
    <div class="chapter-navigation">
      <button id="prev-chapter-btn" class="chapter-nav-btn">Previous</button>
      <button id="next-chapter-btn" class="chapter-nav-btn">Next Chapter</button>
    </div>

    <div id="chapter-not-found" class="chapter-not-found" style="display:none;">
      We couldn’t find this chapter. It may have been removed or not yet created on this device.
    </div>
  </main>

  <script>
    (function () {
      const SERIES_KEY   = 'chapterflow:series';
      const CHAPTERS_KEY = 'chapterflow:chapters';

      function getSeriesList() {
        try {
          const raw = localStorage.getItem(SERIES_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function getChaptersList() {
        try {
          const raw = localStorage.getItem(CHAPTERS_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      const params    = new URLSearchParams(window.location.search);
      const seriesId  = params.get('seriesId');
      const chapterId = params.get('chapterId');

      const backBtn      = document.getElementById('chapter-back-btn');
      const seriesNameEl = document.getElementById('chapter-series-name');
      const authorEl     = document.getElementById('chapter-author');
      const metaLeftEl   = document.getElementById('chapter-meta-left');
      const metaRightEl  = document.getElementById('chapter-meta-right');
      const bodyEl       = document.getElementById('chapter-body');
      const emptyEl      = document.getElementById('chapter-empty');
      const notFoundEl   = document.getElementById('chapter-not-found');

      if (backBtn) {
        backBtn.addEventListener('click', () => {
          if (seriesId) {
            const url = `story.html?seriesId=${encodeURIComponent(seriesId)}`;
            window.location.href = url;
          } else {
            window.location.href = '../Slide nav buttons/edit-profile.html';
          }
        });
      }

      if (!chapterId) {
        if (notFoundEl) notFoundEl.style.display = 'block';
        return;
      }

      // ---- Appwrite setup ----
      let client = null;
      let databases = null;

      const DATABASE_ID            = '69252c2f001121c41ace';
      const STORIES_COLLECTION_ID  = 'stories';
      const CHAPTERS_COLLECTION_ID = 'chapters';

      if (typeof Appwrite !== 'undefined') {
        client = new Appwrite.Client()
          .setEndpoint('https://nyc.cloud.appwrite.io/v1')
          .setProject('69230def0009866e3192');

        databases = new Appwrite.Databases(client);
      }

      function renderChapter(series, chapter) {
        if (!chapter) {
          if (notFoundEl) notFoundEl.style.display = 'block';
          return;
        }

        if (series) {
          if (seriesNameEl) {
            seriesNameEl.textContent = series.title || 'Untitled story';
          }
          if (authorEl && series.ownerName) {
            authorEl.textContent = 'Uploaded by: ' + series.ownerName;
          }
        } else if (seriesNameEl) {
          seriesNameEl.textContent = 'Untitled story';
        }

        const chapterTitle =
          (chapter && chapter.title) || 'Untitled chapter';

        const chapterNumber =
          (chapter && chapter.chapterNumber != null)
            ? chapter.chapterNumber
            : (chapter && chapter.number != null
                ? chapter.number
                : null);

        if (metaLeftEl) {
          if (chapterNumber != null) {
            metaLeftEl.textContent = `Chapter ${chapterNumber} - ${chapterTitle}`;
          } else {
            metaLeftEl.textContent = chapterTitle;
          }
        }

        if (metaRightEl && chapter.createdAt) {
          const dt = new Date(chapter.createdAt);
          if (!isNaN(dt.getTime())) {
            metaRightEl.textContent = dt.toLocaleDateString();
          }
        }

        if (chapter.bodyHtml && bodyEl) {
          bodyEl.innerHTML = chapter.bodyHtml;
        } else if (chapter.bodyText && bodyEl) {
          bodyEl.textContent = chapter.bodyText;
        } else if (emptyEl) {
          emptyEl.style.display = 'block';
        }
      }

      async function loadFromAppwrite() {
        if (!databases) return false;

        let chapterDoc;
        try {
          chapterDoc = await databases.getDocument(
            DATABASE_ID,
            CHAPTERS_COLLECTION_ID,
            chapterId
          );
        } catch (err) {
          console.warn('Chapter not found in Appwrite or failed to load:', err);
          return false;
        }

        let storyId = seriesId || chapterDoc.storyId || null;
        let seriesDoc = null;

        if (storyId) {
          try {
            seriesDoc = await databases.getDocument(
              DATABASE_ID,
              STORIES_COLLECTION_ID,
              storyId
            );
          } catch (err) {
            console.warn('Failed to load series for chapter:', err);
          }
        }

        const chapterData = {
          id:            chapterDoc.$id,
          title:         chapterDoc.chapterTitle || chapterDoc.title || 'Untitled chapter',
          chapterNumber: chapterDoc.chapterNumber ?? chapterDoc.number ?? null,
          bodyHtml:      chapterDoc.fullHtml || chapterDoc.content || chapterDoc.bodyHtml || '',
          bodyText:      chapterDoc.bodyText || '',
          createdAt:     chapterDoc.createdAt
        };

        const seriesData = seriesDoc
          ? {
              id:        seriesDoc.$id,
              title:     seriesDoc.title || 'Untitled story',
              ownerName: seriesDoc.ownerName || ''
            }
          : null;

        renderChapter(seriesData, chapterData);
        return true;
      }

      function loadFromLocalStorage() {
        const seriesList   = getSeriesList();
        const chaptersList = getChaptersList();

        const series  = seriesList.find((s) => String(s.id) === String(seriesId));
        const chapter = chaptersList.find((c) => String(c.id) === String(chapterId));

        renderChapter(series, chapter);
      }

      (async function init() {
        let loaded = false;

        try {
          loaded = await loadFromAppwrite();
        } catch (err) {
          console.warn('Error while loading from Appwrite:', err);
          loaded = false;
        }

        if (!loaded) {
          loadFromLocalStorage();
        }
      })();
    })();
  </script>

  <script>
    (function () {
      const SERIES_KEY   = 'chapterflow:series';
      const CHAPTERS_KEY = 'chapterflow:chapters';

      function getSeriesList() {
        try {
          const raw = localStorage.getItem(SERIES_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function getChaptersList() {
        try {
          const raw = localStorage.getItem(CHAPTERS_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      const params    = new URLSearchParams(window.location.search);
      const seriesId  = params.get('seriesId');
      const chapterId = params.get('chapterId');

      const backBtn      = document.getElementById('chapter-back-btn');
      const seriesNameEl = document.getElementById('chapter-series-name');
      const authorEl     = document.getElementById('chapter-author');
      const metaLeftEl   = document.getElementById('chapter-meta-left');
      const metaRightEl  = document.getElementById('chapter-meta-right');
      const bodyEl       = document.getElementById('chapter-body');
      const emptyEl      = document.getElementById('chapter-empty');
      const notFoundEl   = document.getElementById('chapter-not-found');

      const prevBtn      = document.getElementById('prev-chapter-btn');
      const nextBtn      = document.getElementById('next-chapter-btn');

      // ---------------- BACK BUTTON ----------------
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          if (seriesId) {
            const url = `story.html?seriesId=${encodeURIComponent(seriesId)}`;
            window.location.href = url;
          } else {
            window.location.href = '../Slide nav buttons/edit-profile.html';
          }
        });
      }

      // If no chapterId at all, show not found and hide nav
      if (!chapterId) {
        if (notFoundEl) notFoundEl.style.display = 'block';
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        return;
      }

      // ---------------- APPWRITE SETUP ----------------
      let client = null;
      let databases = null;

      const DATABASE_ID            = '69252c2f001121c41ace';
      const STORIES_COLLECTION_ID  = 'stories';
      const CHAPTERS_COLLECTION_ID = 'chapters';

      if (typeof Appwrite !== 'undefined') {
        client = new Appwrite.Client()
          .setEndpoint('https://nyc.cloud.appwrite.io/v1')
          .setProject('69230def0009866e3192');

        databases = new Appwrite.Databases(client);
      }

      // ---------------- RENDER CHAPTER TEXT ----------------
      function renderChapter(series, chapter) {
        if (!chapter) {
          if (notFoundEl) notFoundEl.style.display = 'block';
          return;
        }

        if (series) {
          if (seriesNameEl) {
            seriesNameEl.textContent = series.title || 'Untitled story';
          }
          if (authorEl && series.ownerName) {
            authorEl.textContent = 'Uploaded by: ' + series.ownerName;
          }
        } else if (seriesNameEl) {
          seriesNameEl.textContent = 'Untitled story';
        }

        const chapterTitle =
          (chapter && chapter.title) || 'Untitled chapter';

        const chapterNumber =
          (chapter && chapter.chapterNumber != null)
            ? chapter.chapterNumber
            : (chapter && chapter.number != null
                ? chapter.number
                : null);

        if (metaLeftEl) {
          if (chapterNumber != null) {
            metaLeftEl.textContent = `Chapter ${chapterNumber} - ${chapterTitle}`;
          } else {
            metaLeftEl.textContent = chapterTitle;
          }
        }

        if (metaRightEl && chapter.createdAt) {
          const dt = new Date(chapter.createdAt);
          if (!isNaN(dt.getTime())) {
            metaRightEl.textContent = dt.toLocaleDateString();
          }
        }

        if (chapter.bodyHtml && bodyEl) {
          bodyEl.innerHTML = chapter.bodyHtml;
        } else if (chapter.bodyText && bodyEl) {
          bodyEl.textContent = chapter.bodyText;
        } else if (emptyEl) {
          emptyEl.style.display = 'block';
        }
      }

      // ---------------- NAVIGATION HELPERS ----------------
      function setupNavFromList(chapters, currentChapterId, storyIdForNav) {
        if (!prevBtn && !nextBtn) return;

        if (!storyIdForNav || !chapters || !chapters.length) {
          if (prevBtn) prevBtn.style.display = 'none';
          if (nextBtn) nextBtn.disabled = true;
          return;
        }

        const filtered = chapters
          .filter((c) => {
            const sId = c.storyId || c.seriesId || c.storyID || c.seriesID;
            return String(sId) === String(storyIdForNav);
          })
          .sort((a, b) => {
            const aNum = a.chapterNumber ?? a.number ?? 0;
            const bNum = b.chapterNumber ?? b.number ?? 0;
            return aNum - bNum;
          });

        if (!filtered.length) {
          if (prevBtn) prevBtn.style.display = 'none';
          if (nextBtn) nextBtn.disabled = true;
          return;
        }

        const currentIndex = filtered.findIndex(
          (c) => String(c.id || c.$id) === String(currentChapterId)
        );

        const prevChapter =
          currentIndex > 0 ? filtered[currentIndex - 1] : null;
        const nextChapter =
          currentIndex >= 0 && currentIndex < filtered.length - 1
            ? filtered[currentIndex + 1]
            : null;

        // ---- Previous button ----
        if (prevBtn) {
          if (prevChapter) {
            const targetId = prevChapter.id || prevChapter.$id;
            prevBtn.style.visibility = 'visible';   // visible from chapter 2+
            prevBtn.disabled = false;
            prevBtn.onclick = () => {
              const url = `chapter.html?seriesId=${encodeURIComponent(
                storyIdForNav
              )}&chapterId=${encodeURIComponent(targetId)}`;
              window.location.href = url;
            };
          } else {
            // First chapter: hide completely
            prevBtn.disabled = true;
            prevBtn.onclick = null;
            prevBtn.style.visibility = 'hidden';
          }
        }

        // ---- Next button ----
        if (nextBtn) {
          if (nextChapter) {
            const targetId = nextChapter.id || nextChapter.$id;
            nextBtn.style.display = 'inline';
            nextBtn.disabled = false;
            nextBtn.onclick = () => {
              const url = `chapter.html?seriesId=${encodeURIComponent(
                storyIdForNav
              )}&chapterId=${encodeURIComponent(targetId)}`;
              window.location.href = url;
            };
          } else {
            // No next chapter yet
            nextBtn.disabled = true;
            nextBtn.onclick = null;
          }
        }
      }

      async function setupNavFromAppwrite(storyIdForNav, currentChapterId) {
        if (!databases || !storyIdForNav) return;

        try {
          const queries = [];
          if (Appwrite.Query) {
            queries.push(Appwrite.Query.equal('storyId', storyIdForNav));
          }

          const res = await databases.listDocuments(
            DATABASE_ID,
            CHAPTERS_COLLECTION_ID,
            queries
          );
          const docs = Array.isArray(res.documents) ? res.documents : [];
          setupNavFromList(docs, currentChapterId, storyIdForNav);
        } catch (err) {
          console.warn('Failed to load chapter list for navigation:', err);
        }
      }

      // ---------------- LOAD FROM APPWRITE ----------------
      async function loadFromAppwrite() {
        if (!databases) return false;

        let chapterDoc;
        try {
          chapterDoc = await databases.getDocument(
            DATABASE_ID,
            CHAPTERS_COLLECTION_ID,
            chapterId
          );
        } catch (err) {
          console.warn('Chapter not found in Appwrite or failed to load:', err);
          return false;
        }

        let storyId = seriesId || chapterDoc.storyId || chapterDoc.seriesId || null;
        let seriesDoc = null;

        if (storyId) {
          try {
            seriesDoc = await databases.getDocument(
              DATABASE_ID,
              STORIES_COLLECTION_ID,
              storyId
            );
          } catch (err) {
            console.warn('Failed to load series for chapter:', err);
          }
        }

        const chapterData = {
          id:            chapterDoc.$id,
          title:         chapterDoc.chapterTitle || chapterDoc.title || 'Untitled chapter',
          chapterNumber: chapterDoc.chapterNumber ?? chapterDoc.number ?? null,
          bodyHtml:      chapterDoc.fullHtml || chapterDoc.content || chapterDoc.bodyHtml || '',
          bodyText:      chapterDoc.bodyText || '',
          createdAt:     chapterDoc.createdAt
        };

        const seriesData = seriesDoc
          ? {
              id:        seriesDoc.$id,
              title:     seriesDoc.title || 'Untitled story',
              ownerName: seriesDoc.ownerName || ''
            }
          : null;

        renderChapter(seriesData, chapterData);

        // Use Appwrite list to wire prev/next
        if (storyId) {
          await setupNavFromAppwrite(storyId, chapterDoc.$id);
        }

        return true;
      }

      // ---------------- LOAD FROM LOCALSTORAGE (FALLBACK) ----------------
      function loadFromLocalStorage() {
        const seriesList   = getSeriesList();
        const chaptersList = getChaptersList();

        const series  = seriesList.find((s) => String(s.id) === String(seriesId));
        const chapter = chaptersList.find((c) => String(c.id) === String(chapterId));

        renderChapter(series, chapter);

        const storyIdForNav =
          seriesId ||
          (chapter && (chapter.seriesId || chapter.storyId)) ||
          (series && series.id);

        setupNavFromList(chaptersList, chapterId, storyIdForNav);
      }

      // ---------------- INITIALIZE ----------------
      (async function init() {
        let loaded = false;

        try {
          loaded = await loadFromAppwrite();
        } catch (err) {
          console.warn('Error while loading from Appwrite:', err);
          loaded = false;
        }

        if (!loaded) {
          loadFromLocalStorage();
        }
      })();
    })();
  </script>


  <section class="footer-main">
    <div class="footer-inner">
      <div class="footer-col company">
        <h3 class="footer-title">ChapterFlow</h3>
        <p class="footer-description">
          A campus reading platform where students discover stories,
          earn rewards, and share their creative voice.
        </p>
      </div>
      <div class="footer-col links">
        <h3 class="footer-title">Quick Links</h3>
        <ul class="footer-links">
          <li><a href="../index.html">Home</a></li>
          <li><a href="../readinghub.html">Explore Stories</a></li>
          <li><a href="../about.html">About Us</a></li>
          <li><a href="../Slide nav buttons/points-rewards.html">Points &amp; Rewards</a></li>
        </ul>
      </div>
      <div class="footer-col connect">
        <h3 class="footer-title">Connect</h3>
        <div class="social-icons">
          <a href="#" aria-label="Facebook"><img src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/6935c0e400277d96f69d/view?project=69230def0009866e3192&mode=admin" alt="Facebook"></a>
          <a href="#" aria-label="Twitter"><img src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/6935c0dd0035010d51ae/view?project=69230def0009866e3192&mode=admin" alt="Twitter"></a>
          <a href="#" aria-label="Instagram"><img src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/6935c0d60001a41452ee/view?project=69230def0009866e3192&mode=admin" alt="Instagram"></a>
        </div>
      </div>
    </div>
    <hr class="footer-divider">
    <div class="footer-bottom">
      <p>© 2025 ChapterFlow. All rights reserved. | Powered by Readdy</p>
    </div>
  </section>
</body>
</html>
