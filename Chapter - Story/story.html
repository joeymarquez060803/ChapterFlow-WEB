<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Story – ChapterFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>
  <script src="../script.js" defer></script>

  <style>
    body.story-page {
      margin: 0;
      font-family: "Merriweather", serif;
      background-color: #f7f3e9;
      color: #3c2b1a;
    }

    .back-btn {
      position: fixed;
      top: 80px;
      left: 20px;
      padding: 6px 10px;
      border-radius: 10px;   /* ← change this to adjust roundness */
      border: 1px solid #3c2b1a;
      background: #f7f3e9;
      font-family: "Merriweather", serif;
      text-decoration: none;
      color: #3c2b1a;
    }



    .story-banner {
      background-color: var(--footer-bg);
      height: 400px;
      width: 100%;
    }

    /* back button position just under navbar, on the brown banner */
    .story-page .back-btn {
      position: absolute;
      top: 80px;   /* adjust up/down as you like */
      left: 20px;  /* adjust left/right as you like */
      z-index: 10;
    }

    .story-layout {
      max-width: 1100px;
      margin: 5px auto 64px;
      padding: 0 16px 48px;
      position: relative;
      top: -180px;

      /* hide card until JS marks it as ready */
      opacity: 0;
      transition: opacity 150ms ease;
    }

    /* when story data is ready */
    .story-layout.is-ready {
      opacity: 1;
    }

    .story-meta {
      margin-left: 12px;
    }

    .story-description-label {
      margin-top: 10px; /* space under the author */
      font-weight: 600;
      font-size: 0.95rem;
    }

    .story-card {
      background-color: #ffffff;
      border-radius: 15px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.13);
      padding: 26px 32px;
      display: grid;
      grid-template-columns: minmax(160px, 220px) 1fr;
      gap: 24px;
      align-items: flex-start;
    }

    .story-cover-box {
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-size: 0.8rem;
      letter-spacing: 0.06em;
      color: rgba(0, 0, 0, 0.5);
      text-align: center;
      padding: 8px;
    }

    .story-cover-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    .story-meta h1 {
      margin: 0 0 6px;
      font-size: 1.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .story-meta .story-tagline {
      margin: 0 0 8px;
      font-size: 0.9rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.55);
    }

    .story-description {
      font-size: 0.95rem;
      line-height: 1.7;
      color: rgba(0, 0, 0, 0.78);
      margin-top: 10px;
      font-style: italic;
    }

    .story-meta p.story-description {
      margin: -5px;
      margin-left: 0px;
      font-size: 0.95rem;
      line-height: 1.6;
      color: rgba(0, 0, 0, 0.75);
    }

    .story-meta .story-author {
      margin-top: 1px;
      font-size: 1rem;
      color: rgba(0, 0, 0, 0.6);
    }

    .story-main-section {
      max-width: 980px;
      margin: -150px auto 72px;
      padding: 0 16px 48px;
    }

    /* big white card holding "Chapters" + list */
    .chapters-card {
      background-color: #ffffff;
      border-radius: 15px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.13);
      padding: 32px 40px 36px;
    }

    /* "Chapters" heading */
    .chapters-header {
      margin-bottom: 24px;
      text-align: center;
    }

    .chapters-header h2 {
      margin: 0;
      font-size: 2.2rem;
      text-transform: uppercase;
      color: #4d3a28;
    }

    /* list layout */
    .chapter-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* each row (the beige bar) */
    .chapter-card {
      background-color: #f5efe3;
      border-radius: 18px;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      border: none;
      box-shadow: none;
      transition: background-color 0.15s ease, box-shadow 0.15s ease,
        transform 0.15s ease;
    }

    .chapter-card:hover {
      background-color: #efe3cf;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    /* left side: circle + text */
    .chapter-left {
      display: flex;
      align-items: center;
      gap: 18px;
      flex: 1;
    }

    /* number circle */
    .chapter-number-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background-color: #d5c093;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: #4d3a28;
      flex-shrink: 0;
    }

    /* title + meta text */
    .chapter-row-main {
      display: flex;
      flex-direction: column;
    }

    .chapter-title {
      margin: 0 0 4px;
      font-size: 1.1rem;
      font-weight: 700;
      color: #4d3a28;
    }

    .chapter-meta-row {
      display: flex;
      gap: 16px;
      font-size: 0.9rem;
      color: rgba(0, 0, 0, 0.6);
    }

    /* little arrow on the right */
    .chapter-arrow {
      font-size: 1.2rem;
      color: #8f7958;
      margin-left: auto;
    }

    /* empty + error messages */
    .chapter-empty {
      text-align: center;
      font-size: 0.9rem;
      color: rgba(0, 0, 0, 0.6);
      margin-top: 18px;
      display: none;
    }

    .story-not-found {
      text-align: center;
      font-size: 0.95rem;
      color: rgba(120, 60, 60, 0.85);
      margin-top: 18px;
    }

    @media (max-width: 768px) {
      .story-layout {
        top: -100px;
      }
      .story-card {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="story-page loading">
  <header>
    <nav class="navbar">
      <button class="hamburger" aria-label="Open menu">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </button>

      <img class="logo" src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/69246729002ff61f16a7/view?project=69230def0009866e3192&mode=admin" alt="Logo">

      <h2 class="site-title">ChapterFlow</h2>

      <div class="nav-links">
        <a href="../ChapterFlow.html" class="nav-link nav-main-link">Home</a>
        <a href="../about.html" class="nav-link nav-main-link">About</a>
        <a href="#" class="nav-link nav-auth-link nav-login-link">Log in</a>
        <a href="#" class="nav-link nav-auth-link nav-signup-cta">Sign up</a>
      </div>
    </nav>

    <div class="slide-nav">
      <button class="close-btn" aria-label="Close menu">&lt;</button>
      <p class="slide-message">Please log in first</p>
      <button class="login-btn">Log in</button>
    </div>
    <div class="backdrop"></div>
  </header>

  <!-- back button under navbar, on the brown banner -->
  <a href="../Slide%20nav%20buttons/edit-profile.html" class="back-btn">← Back</a>





  <div class="story-banner"></div>

  <main>
    <section class="story-layout">
      <article class="story-card">
        <div class="story-cover-box">
          <span id="story-cover-placeholder">COVER</span>
          <img id="story-cover-image" src="" alt="">
        </div>
        <div class="story-meta">
          <p class="story-tagline">Series</p>
          <h1 id="story-title">Story Title</h1>

          <p class="story-author" id="story-author"></p>
          <p class="story-description-label">Description:</p>
          <p class="story-description" id="story-description"></p>
        </div>
      </article>
    </section>

    <section class="story-main-section">
      <div class="chapters-card">
        <div class="chapters-header">
          <h2>Chapters</h2>
        </div>

        <div id="chapter-list" class="chapter-list"></div>
        <p id="chapter-empty" class="chapter-empty">No chapters uploaded yet.</p>

        <div id="story-not-found" class="story-not-found" style="display:none;">
          We couldn’t find this story. It may have been deleted or not yet created.
        </div>
      </div>
    </section>

    <section class="footer-main">
      <div class="footer-inner">
        <div class="footer-col company">
          <h3 class="footer-title">ChapterFlow</h3>
          <p class="footer-description">
            A campus reading platform where students discover stories,
            earn rewards, and share their creative voice.
          </p>
        </div>
        <div class="footer-col links">
          <h3 class="footer-title">Quick Links</h3>
          <ul class="footer-links">
            <li><a href="../ChapterFlow.html">Home</a></li>
            <li><a href="../readinghub.html">Explore Stories</a></li>
            <li><a href="../about.html">About Us</a></li>
            <li><a href="../Slide nav buttons/points-rewards.html">Points &amp; Rewards</a></li>
          </ul>
        </div>
        <div class="footer-col connect">
          <h3 class="footer-title">Connect</h3>
          <div class="social-icons">
            <a href="#" aria-label="Facebook"><img src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/6935c0e400277d96f69d/view?project=69230def0009866e3192&mode=admin" alt="Facebook"></a>
            <a href="#" aria-label="Twitter"><img src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/6935c0dd0035010d51ae/view?project=69230def0009866e3192&mode=admin" alt="Twitter"></a>
            <a href="#" aria-label="Instagram"><img src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/6935c0d60001a41452ee/view?project=69230def0009866e3192&mode=admin" alt="Instagram"></a>
          </div>
        </div>
      </div>
      <hr class="footer-divider">
      <div class="footer-bottom">
        <p>© 2025 ChapterFlow. All rights reserved.</p>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const PROJECT_ID = '69230def0009866e3192';
      const ENDPOINT   = 'https://nyc.cloud.appwrite.io/v1';
      const BUCKET_ID  = '69230e950007fef02b5b';
      const DATABASE_ID            = '69252c2f001121c41ace';
      const STORIES_COLLECTION_ID  = 'stories';
      const CHAPTERS_COLLECTION_ID = 'chapters';

      if (typeof Appwrite === 'undefined') {
        console.error('Appwrite SDK not loaded');
        return;
      }

      const client = new Appwrite.Client()
        .setEndpoint(ENDPOINT)
        .setProject(PROJECT_ID);

      const databases = new Appwrite.Databases(client);

      // Build a public view URL for an image in the bucket
      function getImageUrl(fileId) {
        if (!fileId) return null;
        return (
          ENDPOINT +
          '/storage/buckets/' + BUCKET_ID +
          '/files/' + encodeURIComponent(fileId) +
          '/view?project=' + encodeURIComponent(PROJECT_ID)
        );
      }

      const params   = new URLSearchParams(window.location.search);
      const seriesId = params.get('seriesId');

      const titleEl       = document.getElementById('story-title');
      const descEl        = document.getElementById('story-description');
      const authorEl      = document.getElementById('story-author');
      const coverHolder   = document.getElementById('story-cover-placeholder');
      const coverImg      = document.getElementById('story-cover-image');
      const chapterListEl = document.getElementById('chapter-list');
      const chapterEmpty  = document.getElementById('chapter-empty');
      const storyNotFound = document.getElementById('story-not-found');
      const storyLayout   = document.querySelector('.story-layout');

      async function loadStoryAndChapters() {
        if (!seriesId) {
          storyNotFound.style.display = 'block';
          return;
        }

        try {
          const storyDoc = await databases.getDocument(
            DATABASE_ID,
            STORIES_COLLECTION_ID,
            seriesId
          );

          titleEl.textContent = storyDoc.title || 'Untitled story';
          descEl.textContent  = storyDoc.description || 'No description yet.';

          const uploaderName =
            storyDoc.ownerName || '';
          if (uploaderName) {
            authorEl.textContent = 'Uploaded by: ' + uploaderName.toUpperCase();
          } else {
            authorEl.textContent = '';
          }

          const coverUrl = getImageUrl(storyDoc.coverImageId);
          if (coverUrl) {
            coverImg.src = coverUrl;
            coverImg.style.display = 'block';
            coverHolder.style.display = 'none';
          } else {
            coverImg.style.display = 'none';
            coverHolder.style.display = 'block';
            coverHolder.textContent = 'COVER';
          }

          if (storyLayout) {
            storyLayout.classList.add('is-ready');
          }
        } catch (err) {
          console.error('Failed to load story', err);
          storyNotFound.style.display = 'block';
          return;
        }

        // Chapters for this story
        try {
          const res = await databases.listDocuments(
            DATABASE_ID,
            CHAPTERS_COLLECTION_ID,
            [Appwrite.Query.equal('storyId', seriesId)]
          );

          const chapters = res.documents.sort(
            (a, b) => (a.chapterNumber || 0) - (b.chapterNumber || 0)
          );

          if (!chapters.length) {
            chapterEmpty.style.display = 'block';
            return;
          }

          chapterEmpty.style.display = 'none';

          // helper to show "x weeks ago" style text
          function formatTimeAgo(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';

            const now = new Date();
            const diffMs = now - date;
            const minutes = Math.floor(diffMs / 60000);
            if (minutes < 60) return minutes <= 1 ? '1 min ago' : `${minutes} min ago`;

            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours === 1 ? '1 hour ago' : `${hours} hours ago`;

            const days = Math.floor(hours / 24);
            if (days < 7) return days === 1 ? '1 day ago' : `${days} days ago`;

            const weeks = Math.floor(days / 7);
            if (weeks < 4) return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;

            const months = Math.floor(days / 30);
            if (months < 12)
              return months === 1 ? '1 month ago' : `${months} months ago`;

            const years = Math.floor(days / 365);
            return years === 1 ? '1 year ago' : `${years} years ago`;
          }

          chapters.forEach((doc) => {
            const card = document.createElement('article');
            card.className = 'chapter-card';

            const left = document.createElement('div');
            left.className = 'chapter-left';

            const numCircle = document.createElement('div');
            numCircle.className = 'chapter-number-circle';
            numCircle.textContent =
              doc.chapterNumber != null ? doc.chapterNumber : '';

            const main = document.createElement('div');
            main.className = 'chapter-row-main';

            const title = document.createElement('div');
            title.className = 'chapter-title';
            title.textContent = doc.chapterTitle || 'Untitled chapter';

            const metaRow = document.createElement('div');
            metaRow.className = 'chapter-meta-row';

            const readingMinutes =
              doc.readingTimeMinutes || doc.estimatedMinutes || null;
            if (readingMinutes) {
              const spanTime = document.createElement('span');
              spanTime.textContent = `${readingMinutes} min`;
              metaRow.appendChild(spanTime);
            }

            const created =
              doc.createdAt || doc.$createdAt || null;
            const agoText = formatTimeAgo(created);
            if (agoText) {
              const spanAgo = document.createElement('span');
              if (metaRow.children.length) spanAgo.textContent = `• ${agoText}`;
              else spanAgo.textContent = agoText;
              metaRow.appendChild(spanAgo);
            }

            main.appendChild(title);
            if (metaRow.children.length) main.appendChild(metaRow);

            left.appendChild(numCircle);
            left.appendChild(main);

            const arrow = document.createElement('div');
            arrow.className = 'chapter-arrow';
            arrow.innerHTML = '&rarr;';

            card.appendChild(left);
            card.appendChild(arrow);

            card.addEventListener('click', () => {
              const url = `chapter.html?seriesId=${encodeURIComponent(
                seriesId
              )}&chapterId=${encodeURIComponent(doc.$id)}`;
              window.location.href = url;
            });

            chapterListEl.appendChild(card);
          });
        } catch (err) {
          console.error('Failed to load chapters', err);
          chapterEmpty.style.display = 'block';
        }
      }

      loadStoryAndChapters();
    })();
  </script>
</body>
</html>
