<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Points & Rewards - ChapterFlow</title>

  <!-- Fonts & main styles -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../Style.css">

  <!-- Appwrite SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.0"></script>

  <!-- Main shared script (navbar, auth, etc.) -->
  <script src="../script.js" defer></script>

  <style>
    /* Minimal layout for this page â€” you can move/override in Style.css later */

    main.rewards-main {
      max-width: 960px;
      margin: 120px auto 3rem;
      padding: 0 1.5rem;
      font-family: "Merriweather", serif;
    }

    .rewards-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .rewards-header h1 {
      margin-bottom: 0.5rem;
      font-size: 2rem;
    }

    .rewards-header p {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .rewards-balance {
      text-align: center;
      margin-bottom: 2.5rem;
      font-weight: 600;
    }

    .rewards-balance span {
      font-weight: 700;
    }

    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .reward-card {
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .reward-card img {
      width: 140px;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }

    .reward-card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .reward-cost {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }

    .reward-note {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-bottom: 0.75rem;
    }

    .reward-exchange-btn {
      padding: 0.5rem 1.2rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    /* Simple modal (you can style nicer later) */
    .reward-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .reward-modal-backdrop.active {
      display: flex;
    }

    .reward-modal {
      background: #fff;
      border-radius: 12px;
      max-width: 420px;
      width: 90%;
      padding: 1.5rem 1.25rem 1.25rem;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.18);
      position: relative;
      text-align: left;
      font-family: "Merriweather", serif;
    }

    .reward-modal-close {
      position: absolute;
      top: 0.6rem;
      right: 0.7rem;
      border: none;
      background: transparent;
      font-size: 1.4rem;
      cursor: pointer;
      line-height: 1;
    }

    .reward-modal h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }

    .reward-modal p {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .reward-modal .modal-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }

    .reward-modal button {
      padding: 0.45rem 1rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .modal-exchange-btn {
      /* style this in your CSS to match your brand */
    }

    .modal-cancel-btn {
      background: #eee;
    }

    .exchange-result {
      margin-top: 0.9rem;
      padding: 0.7rem 0.8rem;
      border-radius: 8px;
      background: #f5f5f5;
      font-size: 0.9rem;
    }

    .exchange-code {
      font-family: monospace;
      font-size: 0.95rem;
      background: #fff;
      padding: 0.35rem 0.55rem;
      border-radius: 6px;
      display: inline-block;
      margin: 0.2rem 0 0.4rem;
    }

    .small-note {
      font-size: 0.8rem;
      opacity: 0.8;
    }
  </style>
</head>
<body class="loading">

  <!-- HEADER / NAVBAR (same structure your script.js expects) -->
  <header>
    <nav class="navbar">
      <button class="hamburger" aria-label="Open menu">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </button>

      <img class="logo" src="https://nyc.cloud.appwrite.io/v1/storage/buckets/69230e950007fef02b5b/files/69246729002ff61f16a7/view?project=69230def0009866e3192&mode=admin" alt="Logo">
      <h2><a href="../ChapterFlow.html">ChapterFlow</a></h2>

      <div class="nav-links">
        <a href="../ChapterFlow.html" class="nav-link nav-main-link">Home</a>
        <a href="../about.html" class="nav-link nav-main-link">About</a>
        <a href="#" class="nav-link nav-auth-link nav-login-link">Log in</a>
        <a href="#" class="nav-link nav-auth-link nav-signup-cta">Sign up</a>
      </div>
    </nav>

    <div class="slide-nav">
      <button class="close-btn"><</button>
      <p class="slide-message">Please log in first</p>
      <button class="login-btn">Log in</button>
    </div>
    <div class="backdrop"></div>
  </header>

  <main class="rewards-main">
    <div class="rewards-header">
      <h1>Points & Rewards</h1>
      <p>Exchange your reading points for small rewards. Codes are one-time use â€” show them to the library staff.</p>
    </div>

    <section class="rewards-balance">
      Current points: <span id="rewards-current-points">--</span>
    </section>

    <section class="rewards-grid">
      <!-- PEN -->
      <article class="reward-card" data-reward-key="PEN" data-cost="2">
        <!-- Replace src with your own pen image if you want -->
        <img src="https://images.pexels.com/photos/261748/pexels-photo-261748.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Pen">
        <h2>Library Pen</h2>
        <p class="reward-cost">Cost: 2 points</p>
        <p class="reward-note">Simple black ballpen for everyday notes.</p>
        <button class="reward-exchange-btn">Exchange</button>
      </article>

      <!-- CORRECTION TAPE -->
      <article class="reward-card" data-reward-key="CORR" data-cost="4">
        <!-- Replace src with your own correction tape image if you want -->
        <img src="https://images.pexels.com/photos/209137/pexels-photo-209137.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Correction tape">
        <h2>Correction Tape</h2>
        <p class="reward-cost">Cost: 4 points</p>
        <p class="reward-note">Perfect for fixing written mistakes cleanly.</p>
        <button class="reward-exchange-btn">Exchange</button>
      </article>
    </section>
  </main>

  <!-- MODAL -->
  <div class="reward-modal-backdrop" id="reward-modal-backdrop">
    <div class="reward-modal" id="reward-modal">
      <button class="reward-modal-close" aria-label="Close">&times;</button>
      <h2 id="modal-reward-name">Exchange Reward</h2>
      <p>This reward costs <span id="modal-reward-cost">0</span> points.</p>
      <p>Are you sure you want to exchange your points for this item?</p>

      <div class="modal-actions">
        <button class="modal-cancel-btn" type="button">Cancel</button>
        <button class="modal-exchange-btn" type="button" id="modal-exchange-btn">Exchange</button>
      </div>

      <div class="exchange-result" id="exchange-result" style="display: none;">
        <p>Exchange successful!</p>
        <p>Your code:</p>
        <div class="exchange-code" id="reward-code"></div>
        <p class="small-note">Show this code to the library.</p>
      </div>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- Appwrite setup (separate from script.js) ----------
  const client = new Appwrite.Client()
    .setEndpoint('https://nyc.cloud.appwrite.io/v1')
    .setProject('69230def0009866e3192');

  const account = new Appwrite.Account(client);

  let currentUser = null;
  let currentPoints = 0;
  let selectedReward = null;

  // ---------- DOM refs ----------
  const currentPointsDisplay = document.getElementById('currentPointsDisplay');
  const exchangeButtons      = document.querySelectorAll('.exchange-btn');

  const modal        = document.getElementById('redeemModal');
  const backdrop     = document.getElementById('redeemBackdrop');
  const modalRewardName = document.getElementById('modalRewardName');
  const modalCost    = document.getElementById('modalCost');
  const modalError   = document.getElementById('modalError');
  const confirmBtn   = document.getElementById('confirmExchangeBtn');
  const closeBtn     = document.getElementById('closeRedeemModal');
  const codeSection  = document.getElementById('codeSection');
  const rewardCodeEl = document.getElementById('rewardCode');

  // ---------- Helpers ----------
  async function refreshPoints() {
    if (!account || !currentUser) return;

    try {
      const prefs = await account.getPrefs();
      const raw   = prefs.readingPoints;
      const n     = Number(raw);

      currentPoints = Number.isFinite(n) && n > 0 ? n : 0;

      if (currentPointsDisplay) {
        currentPointsDisplay.textContent = currentPoints;
      }

      // also keep navbar badge in sync if it exists
      const navBadge = document.querySelector('.nav-points-display');
      if (navBadge) {
        navBadge.textContent = `Points: ${currentPoints}`;
      }
    } catch (err) {
      console.warn('Failed to refresh points', err);
      currentPoints = 0;
      if (currentPointsDisplay) currentPointsDisplay.textContent = '0';
    }
  }

  function openModal() {
    if (!modal || !backdrop) return;
    modal.classList.add('open');
    backdrop.classList.add('open');
  }

  function closeModal() {
    if (!modal || !backdrop) return;
    modal.classList.remove('open');
    backdrop.classList.remove('open');
    modalError.textContent = '';
    codeSection.style.display = 'none';
    rewardCodeEl.textContent = '';
    confirmBtn.disabled = false;
  }

  function generateCode(key) {
    const base = (key || 'cf')
      .toUpperCase()
      .replace(/[^A-Z0-9]/g, '')
      .slice(0, 3) || 'CFX';

    const ts   = Date.now().toString(36).toUpperCase();
    const rand = Math.random().toString(36).substring(2, 6).toUpperCase();

    return `CF-${base}-${ts}-${rand}`;
  }

  // ---------- Close modal events ----------
  if (closeBtn)   closeBtn.addEventListener('click', closeModal);
  if (backdrop)   backdrop.addEventListener('click', closeModal);

  // ---------- Confirm Exchange (actual deduction + code) ----------
  if (confirmBtn) {
    confirmBtn.addEventListener('click', async () => {
      if (!selectedReward) return;

      const cost = selectedReward.cost;
      modalError.textContent = '';

      if (!currentUser) {
        modalError.textContent = 'Please log in first.';
        return;
      }

      // ðŸ”’ IMPORTANT PART:
      // Block when 0 points OR not enough for this reward
      if (!Number.isFinite(currentPoints) || currentPoints <= 0 || currentPoints < cost) {
        modalError.textContent = 'Insufficient points for this reward.';
        return;
      }

      try {
        confirmBtn.disabled = true;

        const newTotal = currentPoints - cost;

        // Update points in Appwrite prefs
        await account.updatePrefs({
          readingPoints: newTotal
        });

        currentPoints = newTotal;

        // Update page display
        if (currentPointsDisplay) currentPointsDisplay.textContent = currentPoints;

        // Update navbar badge if present
        const navBadge = document.querySelector('.nav-points-display');
        if (navBadge) navBadge.textContent = `Points: ${currentPoints}`;

        // Generate one-time code
        const code = generateCode(selectedReward.key);
        rewardCodeEl.textContent = code;
        codeSection.style.display = 'block';
      } catch (err) {
        console.error('Error updating points', err);
        modalError.textContent = 'Something went wrong. Please try again.';
      } finally {
        confirmBtn.disabled = false;
      }
    });
  }

  // ---------- When you click "Exchange" on a reward ----------
  exchangeButtons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      modalError.textContent = '';
      codeSection.style.display = 'none';
      rewardCodeEl.textContent = '';

      const key  = btn.dataset.key;          // e.g. "pen" or "tape"
      const cost = Number(btn.dataset.cost) || 0;

      const niceName =
        key === 'pen'  ? 'Library Pen' :
        key === 'tape' ? 'Correction Tape' :
        key;

      selectedReward = { key, cost };

      modalRewardName.textContent = niceName;
      modalCost.textContent = `Cost: ${cost} point${cost === 1 ? '' : 's'}`;

      try {
        currentUser = await account.get();
      } catch {
        currentUser = null;
      }

      if (!currentUser) {
        modalError.textContent = 'Please log in to exchange points.';
      } else {
        await refreshPoints();

        if (currentPoints <= 0) {
          // No points at all
          modalError.textContent = 'You have 0 points. Read chapters to earn points before exchanging.';
        } else if (currentPoints < cost) {
          // Not enough for this specific reward
          modalError.textContent = `You only have ${currentPoints} point(s). You need ${cost}.`;
        }
      }

      openModal();
    });
  });

  // ---------- Initial load: get user + points ----------
  (async function init() {
    try {
      currentUser = await account.get();
    } catch {
      currentUser = null;
    }

    if (currentUser) {
      await refreshPoints();
    } else if (currentPointsDisplay) {
      currentPointsDisplay.textContent = '0';
    }
  })();
});
</script>

</body>
</html>
